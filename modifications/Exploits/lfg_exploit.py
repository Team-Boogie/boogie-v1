import json

from mitmproxy import http

from type_definitions import defaultUserSettings
from utils import checks
from utils import config
from utils import console_logs as logger
import type_definitions

class lfg:
    def __init__(self, userSettings: defaultUserSettings):
        self.userSettings: defaultUserSettings = userSettings

    @checks.is_fortnite_request#needed
    def request(self, flow: http.HTTPFlow):
        if not self.userSettings["premium"]:
            return

        if not (
            "/lfg/fortnite/tags" in flow.request.url.lower()
            and self.userSettings["premium"] == True
        ):
            return

        flow.request.url = flow.request.url.replace(
            "playlist_nobuildbr_squad",
            config.read()["extraSettings"]["playlist"],
        )
        logger.info(f"Matchmaking: {flow.request.url}")

        data: type_definitions.Config = config.read()
        users: list[str] = data["InviteExploit"]["users"]
        assert flow.response is not None
        flow.response.text = json.dumps(obj={"users": users})
        logger.info(flow.request.url)

